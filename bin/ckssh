#!/usr/bin/env bash
set -e

err() { echo 2>&1 "$@"; exit 1; }

[ -d "$XDG_RUNTIME_DIR" ] || err '$XDG_RUNTIME_DIR not set.'
ckssh_socket_dir="$XDG_RUNTIME_DIR/ckssh/socket"

meaning_of_life() { echo 42; }

find_config() {
    local section=$1
    local name=$2
    local conf_file="$HOME/.ssh/ckssh_config"
    [ -r "$conf_file" ] || return 2
    sed -e '/[^ \t]*#/d' -e '/^[ \t]*$/d' "$conf_file" \
        | (while read key value; do
                case "$key" in
                    "$section")
                        if [ "$value" = "$name" ]; then
                            while read k v; do case "$k" in
                                CK_DefineCompartment|CK_Host)
                                    return 0;;
                                *)  echo "$k $v";;
                            esac; done;
                        fi;;
                    *)  : ;;
                esac
           done; return 1)
}

find_host_config()        { find_config CK_Host              "$@"; }
find_compartment_config() { find_config CK_DefineCompartment "$@"; }

ckssh_add() {
    local name="$1"
    local compartment=$(
        find_host_config "$name" | while read key value; do
            :
            case "$key" in
                CK_Compartment) echo "$value";;
            esac
        done
    )
    if find_compartment_config "${compartment:-$name}" >/dev/null; then
        export SSH_AUTH_SOCK="$ckssh_socket_dir/${compartment:-$name}"
    elif [ -n "$compartment" ]; then
        err "Host \"$name\" references" \
            "nonexistent compartment \"${compartment}\"."
    else
        err "No config for host or compartment \"$name\"."
    fi
}

case $(basename "$0") in
    bats-exec-test)     : ;;                        # Unit test mode hack
    ckssh)              err "Write me!";;
    ckssh-add)          ckssh_add "$@"
                        echo "export SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
                        ;;
    *)                  err "Unknown command";;
esac
