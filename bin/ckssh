#!/usr/bin/env bash
set -e

err() { echo 2>&1 "$@"; exit 1; }

[ -d "$XDG_RUNTIME_DIR" ] || err '$XDG_RUNTIME_DIR not set.'
ckssh_socket_dir="$XDG_RUNTIME_DIR/ckssh/socket"

meaning_of_life() { echo 42; }

find_host_config() {
    local host="$1"
    local conf_file="$HOME/.ssh/ckssh_config"
    [ -r "$conf_file" ] || return 2
    sed -e '/[^ \t]*#/d' -e '/^[ \t]*$/d' "$conf_file" \
        | (while read key value; do
                case "$key" in
                    CK_Host)
                        if [ "$value" = "$host" ]; then
                            while read k v; do case "$k" in
                                CK_DefineCompartment|CK_Host)
                                    return 0;;
                                *)  echo "$k $v";;
                            esac; done;
                        fi;;
                    *)  : ;;
                esac
           done; return 1)
}

ckssh_add() {
    local name="$1"
    find_host_config "$name" | (while read key value; do
        case "$key" in
            CK_Compartment)
                echo "export SSH_AUTH_SOCK=$ckssh_socket_dir/$value"
                exit
                ;;
        esac
    done; err "No config for host or compartment $name")
}

case $(basename "$0") in
    bats-exec-test)     : ;;                        # Unit test mode hack
    ckssh)              err "Write me!";;
    ckssh-add)          ckssh_add "$@";;
    *)                  err "Unknown command";;
esac
