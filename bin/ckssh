#!/usr/bin/env bash
set -e

err() { echo 2>&1 "$@"; exit 1; }

[ -d "$XDG_RUNTIME_DIR" ] || err '$XDG_RUNTIME_DIR not set.'
ckssh_socket_dir="$XDG_RUNTIME_DIR/ckssh/socket"

meaning_of_life() { echo 42; }

find_config() {
    local section=$1
    local name=$2
    local conf_file="$HOME/.ssh/ckssh_config"
    [ -r "$conf_file" ] || return 2
    sed -e '/[^ \t]*#/d' -e '/^[ \t]*$/d' "$conf_file" \
        | (while read key value; do
                case "$key" in
                    "$section")
                        if [ "$value" = "$name" ]; then
                            while read k v; do case "$k" in
                                CK_DefineCompartment|CK_Host)
                                    return 0;;
                                *)  echo "$k $v";;
                            esac; done;
                        fi;;
                    *)  : ;;
                esac
           done; return 1)
}

find_host_config()        { find_config CK_Host              "$@"; }
find_compartment_config() { find_config CK_DefineCompartment "$@"; }

ckssh_add() {
    local name="$1"
    local host_compartment=$(
        find_host_config "$name" | while read key value; do
            :
            case "$key" in
                CK_Compartment) echo "$value";;
            esac
        done
    )
    local compartment="${host_compartment:-$name}"
    if find_compartment_config "$compartment" >/dev/null; then
        export SSH_AUTH_SOCK="$ckssh_socket_dir/$compartment"
    elif [ -n "$host_compartment" ]; then
        err "Host \"$name\" references" \
            "nonexistent compartment \"${host_compartment}\"."
    else
        err "No config for host or compartment \"$name\"."
    fi
}

execute_ckssh_add() {
    mkdir -m 0700 -p $(dirname "$SSH_AUTH_SOCK")

    e=$(ssh-add -l >/dev/null 2>&1; echo $?)
    case $e in
        0) : ;;     # Running with identities
        1) : ;;     # No identities
        2) eval $(ssh-agent -a "$SSH_AUTH_SOCK" || echo false) >/dev/null;;
        *) err "Unknown error from ssh-add -l: $e";;
    esac
}

unset SSH_AUTH_SOCK
case $(basename "$0") in
    bats-exec-test)     : ;;                        # Unit test mode hack
    ckssh)              err "Write me!";;
    ckssh-add)          ckssh_add "$@"
                        execute_ckssh_add
                        echo "export SSH_AUTH_SOCK=$SSH_AUTH_SOCK"
                        ;;
    *)                  err "Unknown command";;
esac
